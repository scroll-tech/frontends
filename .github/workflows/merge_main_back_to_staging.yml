name: "Merge main back to staging"

on:
  pull_request:
    branches:
      - main
      - test-version-bump
    types:
      - closed

jobs:
  create-merge-back-pr:
    if: |
      contains(github.event.pull_request.title , ' [bot]')
    name: "Create PR to merge main back to staging"
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout source code"
        uses: "actions/checkout@v3"
      # - name: Create PR
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.WRITE_TOKEN }}
      #   run: |
      #     gh pr create --base test-version-bump-staging \
      #                  --title 'ci: merge main branch back to staging [bot]' \
      #                  --body ''
      - name: Create PR
        run: |
          git config user.name sync-main-back
          git config user.email sync-main-back@users.noreply.github.com
          git checkout test-version-bump-staging
          git merge -v --no-edit --no-commit test-version-bump
      - name: Create Pull Request for Staging
        uses: peter-evans/create-pull-request@2b011faafdcbc9ceb11414d64d0573f37c774b04
        with:
          token: ${{ secrets.WRITE_TOKEN }}
          delete-branch: true
          branch: ci/_main->staging
          branch-suffix: short-commit-hash
          base: "test-version-bump-staging"
          title: "ci: merge main branch back to staging [bot]"
          labels: "bot/main->staging, automerge"
          body: ""
